<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TUI Proactive Orchestration Portal</title>
  <style>
    :root{
      --tui-base:#E2F4FD;
      --tui-ink:#0b2b3a;
      --tui-muted:#4b6470;
      --tui-border:rgba(11,43,58,.14);
      --tui-card:#ffffff;
      --tui-accent:#0a7fc2;
      --tui-accent2:#0bb3c8;
      --ok:#00703C;
      --warn:#B58800;
      --bad:#D4351C;

      --shadow:0 10px 30px rgba(0,0,0,.08);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:linear-gradient(180deg, var(--tui-base), #f7fcff 55%, #ffffff);
      color:var(--tui-ink);
    }

    .topbar{
      position:sticky; top:0; z-index:10;
      background:rgba(226,244,253,.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--tui-border);
      box-shadow:0 2px 0 rgba(0,0,0,.04);
      padding:14px 18px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width:260px;
    }
    .tui-badge{
      background:#fff;
      border:1px solid var(--tui-border);
      color:var(--tui-ink);
      font-weight:900;
      letter-spacing:.4px;
      padding:10px 12px;
      border-radius:14px;
      line-height:1;
      display:flex; align-items:center; gap:12px;
    }

    /* BIGGER logo, no border */
    .logo-wrap{
      width:68px;
      height:68px;
      border-radius:16px;
      border:none;
      background:transparent;
      display:grid;
      place-items:center;
      overflow:visible;
      flex:0 0 auto;
    }
    .logo-wrap img{
      width:68px;
      height:68px;
      object-fit:contain;
      display:block;
      filter:drop-shadow(0 10px 18px rgba(0,0,0,.14));
    }

    .titleblock{display:flex; flex-direction:column; line-height:1.1}
    .titleblock .title{font-weight:900; font-size:14px}
    .titleblock .subtitle{font-size:12px; color:rgba(11,43,58,.7); margin-top:3px}

    .right{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .chip{
      border:1px solid rgba(11,43,58,.14);
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      background:rgba(255,255,255,.75);
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .chip strong{font-weight:900}

    .container{
      max-width:1240px;
      margin:18px auto 34px;
      padding:0 16px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .brand{min-width:auto}
    }

    .card{
      background:rgba(255,255,255,.88);
      border:1px solid var(--tui-border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--tui-border);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      background:linear-gradient(180deg, rgba(226,244,253,.75), rgba(255,255,255,.75));
    }
    .card-h h2{
      margin:0;
      font-size:15px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .card-h p{
      margin:6px 0 0;
      color:var(--tui-muted);
      font-size:12.5px;
      max-width:70ch;
    }
    .card-b{padding:14px}

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
    }
    .left-tools{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .search{
      display:flex;
      align-items:center;
      gap:8px;
      padding:9px 10px;
      border:1px solid var(--tui-border);
      border-radius:14px;
      background:#fff;
      min-width:280px;
    }
    .search input{
      border:none;
      outline:none;
      font-size:13px;
      width:100%;
    }
    .select, .input{
      border:1px solid var(--tui-border);
      border-radius:14px;
      padding:9px 10px;
      background:#fff;
      font-size:13px;
    }

    .btn{
      border:1px solid transparent;
      border-radius:14px;
      padding:10px 12px;
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition:transform .04s ease, filter .10s ease, box-shadow .10s ease;
      user-select:none;
    }
    .btn:active{transform:translateY(1px)}
    .btn-primary{
      background:linear-gradient(180deg, var(--tui-accent), #056aa5);
      color:#fff;
      box-shadow:0 8px 18px rgba(10,127,194,.18);
    }
    .btn-primary:hover{filter:brightness(1.06)}
    .btn-ghost{
      background:#fff;
      border-color:var(--tui-border);
      color:var(--tui-ink);
    }
    .btn-ghost:hover{filter:brightness(.98)}
    .btn-small{padding:8px 10px; border-radius:12px; font-size:12.5px; font-weight:950;}

    .pill{
      display:inline-flex;
      align-items:center;
      gap:7px;
      padding:5px 9px;
      border-radius:999px;
      border:1px solid var(--tui-border);
      font-size:12px;
      background:#fff;
      color:var(--tui-muted);
      white-space:nowrap;
    }
    .pill.ok{border-color:rgba(0,112,60,.35); color:var(--ok); background:rgba(0,112,60,.06)}
    .pill.warn{border-color:rgba(181,136,0,.35); color:var(--warn); background:rgba(181,136,0,.08)}
    .pill.bad{border-color:rgba(212,53,28,.30); color:var(--bad); background:rgba(212,53,28,.06)}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--tui-border);
      border-radius:16px;
      background:#fff;
    }
    thead th{
      text-align:left;
      font-size:12px;
      color:var(--tui-muted);
      font-weight:950;
      padding:10px 10px;
      background:linear-gradient(#fff, #fbfdff);
      border-bottom:1px solid var(--tui-border);
    }
    tbody td{
      padding:11px 10px;
      border-bottom:1px solid var(--tui-border);
      font-size:13px;
      vertical-align:middle;
    }
    tbody tr:last-child td{border-bottom:none}
    tbody tr:hover td{background:#f6fcff}

    .name{
      font-weight:950;
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .small{font-size:12px; color:var(--tui-muted); font-weight:650}
    .muted{color:var(--tui-muted)}
    .checkbox{
      width:18px; height:18px;
      accent-color:var(--tui-accent);
      cursor:pointer;
    }

    .codebox{
      margin-top:10px;
      border:1px solid rgba(11,43,58,.18);
      background:#0b1020;
      color:#e9ecff;
      border-radius:16px;
      padding:12px;
      font-family:var(--mono);
      font-size:12px;
      overflow:auto;
      max-height:280px;
      white-space:pre;
    }
    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin:10px 0 14px;
    }
    .kvc{
      border:1px solid var(--tui-border);
      border-radius:16px;
      background:#fff;
      padding:10px;
    }
    .kvc .k{font-size:12px; color:var(--tui-muted); font-weight:950}
    .kvc .v{font-size:18px; font-weight:1000; margin-top:2px}

    .divider{height:1px; background:var(--tui-border); margin:12px 0}

    .warnbox{
      border:1px solid rgba(181,136,0,.35);
      background:rgba(181,136,0,.10);
      border-radius:16px;
      padding:10px;
      color:#5a4600;
      font-size:12.5px;
      line-height:1.4;
    }

    /* flashing lights */
    .lights{display:flex; gap:8px; align-items:center; justify-content:flex-end; padding-top:2px}
    .light{
      width:10px; height:10px; border-radius:999px;
      background:rgba(11,43,58,.18);
      border:1px solid rgba(11,43,58,.18);
    }
    .light.on{
      animation:pulse 1.1s infinite ease-in-out;
      background:var(--tui-accent2);
      border-color:rgba(11,179,200,.6);
      box-shadow:0 0 18px rgba(11,179,200,.55);
    }
    .light.on.fast{animation-duration:.65s}
    .light.on.slow{animation-duration:1.55s}
    @keyframes pulse{
      0%, 100%{transform:scale(1); filter:brightness(1)}
      50%{transform:scale(1.3); filter:brightness(1.15)}
    }

    .act{display:inline-flex; align-items:center; gap:8px}
    .spark{
      width:10px; height:10px; border-radius:999px;
      background:rgba(10,127,194,.18);
      border:1px solid rgba(10,127,194,.25);
    }
    .spark.blink{animation:blink 1.2s infinite}
    @keyframes blink{
      0%, 100%{opacity:.35; transform:scale(1)}
      50%{opacity:1; transform:scale(1.25); box-shadow:0 0 16px rgba(10,127,194,.45)}
    }

    a.crm{color:var(--tui-accent); text-decoration:none; font-weight:950}
    a.crm:hover{text-decoration:underline}

    .proc{
      display:none;
      margin-top:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(11,179,200,.35);
      background:linear-gradient(90deg, rgba(11,179,200,.12), rgba(226,244,253,.55));
      color:var(--tui-ink);
      font-size:12.5px;
      font-weight:800;
    }
    .proc.show{display:block}
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <div class="tui-badge">
        <div class="logo-wrap" title="TUI">
          <img
            src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ5GimTdyv3iMaPNShqBpSmUwxxhFqCJVsf5g&s"
            alt="TUI"
          />
        </div>
        <div class="titleblock">
          <div class="title">Proactive Orchestration Portal</div>
          <div class="subtitle">Outbound customer messaging ‚Ä¢ Cancun departures 1 July 2026</div>
        </div>
      </div>
    </div>

    <div class="right">
      <div class="chip"><strong>Destination</strong> Cancun</div>
      <div class="chip"><strong>Outbound</strong> 1 Jul 2026</div>
      <div class="chip"><strong>Return</strong> 15 Jul 2026</div>
      <div class="chip">
        <strong>Activity</strong>
        <span class="lights" aria-label="Activity lights">
          <span class="light on fast"></span>
          <span class="light on"></span>
          <span class="light on slow"></span>
        </span>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="grid">
      <section class="card">
        <div class="card-h">
          <div>
            <h2>Customers</h2>
            <p>
              Choose <strong>Andy Martin</strong> and click <strong>Simulate Proactive</strong>.
              This triggers a single webhook call using the selected customer <strong>userId</strong>.
            </p>
          </div>
          <div class="pill"><span class="spark blink"></span> Proactive platform</div>
        </div>

        <div class="card-b">
          <div class="toolbar">
            <div class="left-tools">
              <div class="search" title="Filter by name, booking, or destination">
                <span class="muted">üîé</span>
                <input id="search" type="text" placeholder="Search customers‚Ä¶" />
              </div>

              <select id="msgFilter" class="select" title="Message type">
                <option value="all">All message types</option>
                <option value="checkin">Online Check-In open</option>
                <option value="gate">Outbound gate info</option>
                <option value="delay">Return flight delay</option>
              </select>
            </div>

            <div style="display:flex; gap:10px; align-items:center;">
              <button class="btn btn-ghost" id="selectAndyBtn">Select Andy</button>
              <button class="btn btn-primary" id="simulateBtn">‚ö° Simulate Proactive</button>
            </div>
          </div>

          <table aria-label="Customers table">
            <thead>
              <tr>
                <th style="width:40px;"></th>
                <th>Customer</th>
                <th>Booking</th>
                <th>Trip</th>
                <th>Proactive</th>
                <th style="width:200px; text-align:right;">CRM</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>

          <div class="proc" id="procBanner">Processing outbound proactive event‚Ä¶</div>
        </div>
      </section>

      <aside class="card">
        <div class="card-h">
          <div>
            <h2>Outbound control</h2>
            <p>Webhook config, request status and last payload.</p>
          </div>
          <div class="pill ok">
            <span style="width:8px;height:8px;border-radius:999px;background:var(--ok);display:inline-block"></span>
            Ready
          </div>
        </div>

        <div class="card-b">
          <div class="kv">
            <div class="kvc">
              <div class="k">Selected</div>
              <div class="v" id="selectedName">None</div>
            </div>
            <div class="kvc">
              <div class="k">Webhook calls</div>
              <div class="v" id="callCount">0</div>
            </div>
            <div class="kvc">
              <div class="k">Last event</div>
              <div class="v" id="lastEvent">‚Äî</div>
            </div>
            <div class="kvc">
              <div class="k">Last status</div>
              <div class="v" id="lastStatus">‚Äî</div>
            </div>
          </div>

          <div class="divider"></div>

          <label class="small" for="webhookUrl">Cognigy Webhook URL</label>
          <input class="input" id="webhookUrl" style="width:100%; margin-top:6px;"
                 value="https://endpoint-trial.cognigy.ai/e6389b86b7b6b3a99848b060b92640414c17ecc0712d3e092c9b9ecbb30c3090" />

          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
            <div>
              <label class="small" for="eventType">Proactive event</label>
              <select class="select" id="eventType" style="width:100%; margin-top:6px;">
                <option value="ONLINE_CHECKIN_OPEN">Online Check-In open</option>
                <option value="OUTBOUND_GATE_INFO">Outbound gate info</option>
                <option value="RETURN_FLIGHT_DELAY">Return flight delay</option>
              </select>
            </div>
            <div>
              <label class="small" for="campaignName">Campaign name</label>
              <input class="input" id="campaignName" style="width:100%; margin-top:6px;" value="TUI Cancun Proactive" />
            </div>
          </div>

          <div class="divider"></div>

          <div class="warnbox">
            <strong>Important:</strong> This sends only the selected customer's <strong>userId</strong> and basic trip/event context.
            No phone number is sent.
          </div>

          <div class="divider"></div>

          <div class="small" style="display:flex; justify-content:space-between; align-items:center;">
            <span>Last request payload</span>
            <button class="btn btn-ghost btn-small" id="copyPayloadBtn">Copy</button>
          </div>
          <div class="codebox" id="payloadBox">{}</div>

          <div class="small" style="margin-top:10px;">Live log</div>
          <div class="codebox" id="logBox" style="max-height:220px;"></div>
        </div>
      </aside>
    </div>
  </main>

  <script>
    const customers = [
      { userId:"CUST-900312", name:"Andy Martin", bookingRef:"TUI-7K2Q9M", outbound:"2026-07-01", inbound:"2026-07-15", from:"LGW", to:"CUN", crmUrl:"https://crm.tui.local/customer/CUST-900312" },

      { userId:"CUST-900287", name:"Sofia Alvarez", bookingRef:"TUI-5P8R1D", outbound:"2026-07-01", inbound:"2026-07-15", from:"MAN", to:"CUN", crmUrl:"https://crm.tui.local/customer/CUST-900287" },
      { userId:"CUST-900155", name:"Jacob Turner", bookingRef:"TUI-3H1Z6A", outbound:"2026-07-01", inbound:"2026-07-15", from:"BHX", to:"CUN", crmUrl:"https://crm.tui.local/customer/CUST-900155" },
      { userId:"CUST-900499", name:"Amina Rahman", bookingRef:"TUI-9M4B2K", outbound:"2026-07-01", inbound:"2026-07-15", from:"LGW", to:"CUN", crmUrl:"https://crm.tui.local/customer/CUST-900499" },
      { userId:"CUST-900021", name:"Ben Collins", bookingRef:"TUI-1Q7W3E", outbound:"2026-07-01", inbound:"2026-07-15", from:"NCL", to:"CUN", crmUrl:"https://crm.tui.local/customer/CUST-900021" },
      { userId:"CUST-900804", name:"Harpreet Singh", bookingRef:"TUI-2V6N8T", outbound:"2026-07-01", inbound:"2026-07-15", from:"MAN", to:"CUN", crmUrl:"https://crm.tui.local/customer/CUST-900804" },
      { userId:"CUST-900613", name:"Chloe Bennett", bookingRef:"TUI-6D3F9S", outbound:"2026-07-01", inbound:"2026-07-15", from:"LGW", to:"CUN", crmUrl:"https://crm.tui.local/customer/CUST-900613" },
      { userId:"CUST-900742", name:"Mason Wright", bookingRef:"TUI-8J5L0C", outbound:"2026-07-01", inbound:"2026-07-15", from:"GLA", to:"CUN", crmUrl:"https://crm.tui.local/customer/CUST-900742" },
      { userId:"CUST-900318", name:"Emily Foster", bookingRef:"TUI-4X2K7P", outbound:"2026-07-01", inbound:"2026-07-15", from:"BHX", to:"CUN", crmUrl:"https://crm.tui.local/customer/CUST-900318" },
      { userId:"CUST-900907", name:"Noah Patel", bookingRef:"TUI-0R9T4H", outbound:"2026-07-01", inbound:"2026-07-15", from:"LGW", to:"CUN", crmUrl:"https://crm.tui.local/customer/CUST-900907" },
      { userId:"CUST-900564", name:"Isla Campbell", bookingRef:"TUI-7S1D5Y", outbound:"2026-07-01", inbound:"2026-07-15", from:"EDI", to:"CUN", crmUrl:"https://crm.tui.local/customer/CUST-900564" },
      { userId:"CUST-900233", name:"Theo Johnson", bookingRef:"TUI-2A9G6U", outbound:"2026-07-01", inbound:"2026-07-15", from:"MAN", to:"CUN", crmUrl:"https://crm.tui.local/customer/CUST-900233" },
      { userId:"CUST-900671", name:"Grace Lewis", bookingRef:"TUI-5N7P3B", outbound:"2026-07-01", inbound:"2026-07-15", from:"LGW", to:"CUN", crmUrl:"https://crm.tui.local/customer/CUST-900671" },
      { userId:"CUST-900488", name:"Liam O'Connor", bookingRef:"TUI-9C2V8W", outbound:"2026-07-01", inbound:"2026-07-15", from:"DUB", to:"CUN", crmUrl:"https://crm.tui.local/customer/CUST-900488" },
      { userId:"CUST-900119", name:"Mia Hughes", bookingRef:"TUI-3T6H1Q", outbound:"2026-07-01", inbound:"2026-07-15", from:"LGW", to:"CUN", crmUrl:"https://crm.tui.local/customer/CUST-900119" },
      { userId:"CUST-900356", name:"Ethan Price", bookingRef:"TUI-6K0M2J", outbound:"2026-07-01", inbound:"2026-07-15", from:"MAN", to:"CUN", crmUrl:"https://crm.tui.local/customer/CUST-900356" },
      { userId:"CUST-900902", name:"Zara Ahmed", bookingRef:"TUI-8B4Q1N", outbound:"2026-07-01", inbound:"2026-07-15", from:"BHX", to:"CUN", crmUrl:"https://crm.tui.local/customer/CUST-900902" },
      { userId:"CUST-900744", name:"Oliver Green", bookingRef:"TUI-1L9S7R", outbound:"2026-07-01", inbound:"2026-07-15", from:"LHR", to:"CUN", crmUrl:"https://crm.tui.local/customer/CUST-900744" },
      { userId:"CUST-900633", name:"Freya Morgan", bookingRef:"TUI-4D8X2Z", outbound:"2026-07-01", inbound:"2026-07-15", from:"MAN", to:"CUN", crmUrl:"https://crm.tui.local/customer/CUST-900633" },
      { userId:"CUST-900505", name:"Kai Nguyen", bookingRef:"TUI-7H3J5V", outbound:"2026-07-01", inbound:"2026-07-15", from:"LGW", to:"CUN", crmUrl:"https://crm.tui.local/customer/CUST-900505" },
      { userId:"CUST-900882", name:"Ella Roberts", bookingRef:"TUI-0P6W9K", outbound:"2026-07-01", inbound:"2026-07-15", from:"BRS", to:"CUN", crmUrl:"https://crm.tui.local/customer/CUST-900882" },
      { userId:"CUST-900164", name:"Samuel Scott", bookingRef:"TUI-2Y8N0F", outbound:"2026-07-01", inbound:"2026-07-15", from:"LGW", to:"CUN", crmUrl:"https://crm.tui.local/customer/CUST-900164" },
      { userId:"CUST-900279", name:"Hannah Ward", bookingRef:"TUI-5Q1C7D", outbound:"2026-07-01", inbound:"2026-07-15", from:"MAN", to:"CUN", crmUrl:"https://crm.tui.local/customer/CUST-900279" },
      { userId:"CUST-900413", name:"Dylan Evans", bookingRef:"TUI-9R4T6A", outbound:"2026-07-01", inbound:"2026-07-15", from:"GLA", to:"CUN", crmUrl:"https://crm.tui.local/customer/CUST-900413" },
      { userId:"CUST-900590", name:"Layla King", bookingRef:"TUI-6V2B8M", outbound:"2026-07-01", inbound:"2026-07-15", from:"LGW", to:"CUN", crmUrl:"https://crm.tui.local/customer/CUST-900590" },
      { userId:"CUST-900331", name:"Finn Baker", bookingRef:"TUI-1N5S3P", outbound:"2026-07-01", inbound:"2026-07-15", from:"MAN", to:"CUN", crmUrl:"https://crm.tui.local/customer/CUST-900331" },
      { userId:"CUST-900726", name:"Lucy Perry", bookingRef:"TUI-8X1Q4L", outbound:"2026-07-01", inbound:"2026-07-15", from:"LHR", to:"CUN", crmUrl:"https://crm.tui.local/customer/CUST-900726" }
    ];

    const state = {
      selectedUserId: null,
      stats: { calls: 0 },
      lastPayload: {},
      lastEvent: null,
      lastStatus: "‚Äî"
    };

    const tbody = document.getElementById("tbody");
    const search = document.getElementById("search");
    const msgFilter = document.getElementById("msgFilter");
    const selectedName = document.getElementById("selectedName");
    const callCount = document.getElementById("callCount");
    const lastEvent = document.getElementById("lastEvent");
    const lastStatus = document.getElementById("lastStatus");
    const payloadBox = document.getElementById("payloadBox");
    const logBox = document.getElementById("logBox");
    const webhookUrlEl = document.getElementById("webhookUrl");
    const eventTypeEl = document.getElementById("eventType");
    const campaignNameEl = document.getElementById("campaignName");
    const procBanner = document.getElementById("procBanner");

    function log(line){
      const ts = new Date().toLocaleTimeString();
      logBox.textContent = `[${ts}] ${line}\n` + logBox.textContent;
    }
    function updateStats(){
      callCount.textContent = String(state.stats.calls);
      lastEvent.textContent = state.lastEvent || "‚Äî";
      lastStatus.textContent = state.lastStatus || "‚Äî";
    }
    function setLastPayload(payload){
      state.lastPayload = payload;
      payloadBox.textContent = JSON.stringify(payload, null, 2);
    }

    function proactiveLabel(){
      const v = msgFilter.value;
      if (v === "checkin") return "Online Check-In open";
      if (v === "gate") return "Outbound gate info";
      if (v === "delay") return "Return flight delay";
      return "Mixed activity";
    }

    function filteredCustomers(){
      const q = search.value.trim().toLowerCase();
      return customers.filter(c => {
        const hay = `${c.name} ${c.userId} ${c.bookingRef} ${c.from} ${c.to} ${c.outbound} ${c.inbound}`.toLowerCase();
        return !q || hay.includes(q);
      });
    }

    function render(){
      const rows = filteredCustomers().map(c => {
        const isSelected = state.selectedUserId === c.userId;
        const activityClass = isSelected ? "blink" : (Math.random() < 0.22 ? "blink" : "");
        return `
          <tr>
            <td>
              <input class="checkbox pick" type="radio" name="pickOne"
                     data-userid="${c.userId}" ${isSelected ? "checked" : ""} />
            </td>
            <td>
              <div class="name">
                <span>${c.name}</span>
                <span class="small">${c.userId} ‚Ä¢ Booking <span class="muted">${c.bookingRef}</span></span>
              </div>
            </td>
            <td>
              <div><strong>${c.bookingRef}</strong></div>
              <div class="small">All pax: Cancun</div>
            </td>
            <td>
              <div><strong>${c.outbound}</strong> outbound</div>
              <div class="small">${c.inbound} return</div>
            </td>
            <td>
              <div class="act">
                <span class="spark ${activityClass}"></span>
                <span class="small">${proactiveLabel()}</span>
              </div>
            </td>
            <td style="text-align:right;">
              <a class="crm" href="${c.crmUrl}" target="_blank" rel="noopener">Open CRM</a>
            </td>
          </tr>
        `;
      }).join("");

      tbody.innerHTML = rows || `
        <tr><td colspan="6" class="muted" style="padding:16px;">No customers match the current filter.</td></tr>
      `;

      const selected = customers.find(x => x.userId === state.selectedUserId);
      selectedName.textContent = selected ? selected.name : "None";

      updateStats();
    }

    function buildPayloadFor(userId){
      const selected = customers.find(c => c.userId === userId);
      if (!selected) throw new Error("Selected customer not found.");

      const campaignName = campaignNameEl.value.trim() || "TUI Cancun Proactive";
      const eventType = eventTypeEl.value;

      return {
        userId: selected.userId,
        sessionId: `tui-proactive-${Date.now()}`,
        text: "trigger proactive message",
        data: {
          campaignName,
          eventType,
          customer: { name: selected.name, bookingRef: selected.bookingRef },
          trip: {
            destination: "Cancun",
            outboundDate: "2026-07-01",
            returnDate: "2026-07-15",
            route: { from: selected.from, to: selected.to }
          }
        }
      };
    }

    async function postToWebhook(payload){
      const url = webhookUrlEl.value.trim();
      if (!url) throw new Error("Webhook URL is empty.");

      state.stats.calls += 1;
      state.lastEvent = payload.data.eventType;
      state.lastStatus = "POSTING‚Ä¶";
      updateStats();
      setLastPayload(payload);

      procBanner.classList.add("show");
      log(`POST webhook ‚Üí userId=${payload.userId} sessionId=${payload.sessionId} eventType=${payload.data.eventType}`);

      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const text = await res.text().catch(() => "");
      if (!res.ok){
        throw new Error(`HTTP ${res.status}: ${text || res.statusText}`);
      }
      return text;
    }

    async function simulateProactive(){
      if (!state.selectedUserId){
        alert("Select Andy Martin (or another customer) first.");
        return;
      }

      const payload = buildPayloadFor(state.selectedUserId);

      try{
        const responseText = await postToWebhook(payload);
        state.lastStatus = "SENT ‚úÖ";
        updateStats();
        log(`‚úÖ Sent ONE webhook call. Response: ${responseText || "(empty)"}`);
      }catch(err){
        state.lastStatus = "FAILED ‚ùå";
        updateStats();
        log(`‚ùå Failed: ${err.message}`);
        alert(
          "Webhook call failed from the browser.\n\n" +
          "If it works in Postman, route the request via your backend/proxy.\n\n" +
          "Error:\n" + err.message
        );
      }finally{
        setTimeout(() => procBanner.classList.remove("show"), 900);
      }
    }

    document.getElementById("simulateBtn").addEventListener("click", simulateProactive);

    document.getElementById("selectAndyBtn").addEventListener("click", () => {
      const andy = customers.find(c => c.name === "Andy Martin");
      if (!andy) return;
      state.selectedUserId = andy.userId;
      render();
      log(`Selected Andy Martin (${andy.userId}).`);
      setLastPayload(buildPayloadFor(andy.userId));
    });

    tbody.addEventListener("change", (e) => {
      const pick = e.target.closest(".pick");
      if (!pick) return;
      state.selectedUserId = pick.getAttribute("data-userid");
      render();

      const c = customers.find(x => x.userId === state.selectedUserId);
      if (c){
        log(`Selected ${c.name} (${c.userId}).`);
        setLastPayload(buildPayloadFor(c.userId));
      }
    });

    [search, msgFilter].forEach(el => el.addEventListener("input", render));
    msgFilter.addEventListener("change", render);

    document.getElementById("copyPayloadBtn").addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(JSON.stringify(state.lastPayload, null, 2));
        log("Copied last payload to clipboard.");
      }catch{
        const ta = document.createElement("textarea");
        ta.value = JSON.stringify(state.lastPayload, null, 2);
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        log("Copied last payload to clipboard (fallback).");
      }
    });

    (function init(){
      const andy = customers.find(c => c.name === "Andy Martin");
      state.selectedUserId = andy ? andy.userId : null;
      render();
      if (state.selectedUserId){
        setLastPayload(buildPayloadFor(state.selectedUserId));
        log("Portal loaded. Andy Martin preselected. Click ‚ÄúSimulate Proactive‚Äù to send one webhook call.");
      }else{
        log("Portal loaded. Select a customer then click ‚ÄúSimulate Proactive‚Äù.");
      }
    })();
  </script>
</body>
</html>